# API

This document provides details about the API endpoints available for
handling page state and learner progress data. It includes the
required headers, methods, and the expected format of requests and
responses.

## Base URL

All endpoints are relative to the base URL provided by the audience
(`aud`) claim in the JWT.  This permits the same content to be used by
multiple ("decentralized") gradebooks.

For example, for users originating from https://dear.college, the
`aud` in the JWT will be https://dear.college

## Redirect flow

Suppose the user already has a `dear.college` cookie by logging into
https://dear.college and then when that user visits

https://dear.college/courses/:slug/https://external.tool/

they are directed to https://external.tool/#jwt-scoped-to-external-tool

The `scp` in the JWT will be ["https://external.tool/"]

The `sub` claim identifies the user.

Since `external.tool` is running the dear.college client code, the
page looks for the JWT stored in the URL hash, decodes it, and makes
cross-origin requests to https://dear.college to get and set progress
and page state.

## Authorization

All requests to the API must include a valid JSON Web Token (JWT) in
the `Authorization` header.

External tools will likely store in the JWT in local storage under the
key `dear.college/jwt` regardless of the `aud` claim in the JWT.

## Headers
- **Authorization**: `Bearer <JWT>` - Required for all requests.
- **Worksheet**: `<location>` - Required for all requests, representing the location of the educational content.
- **JSON-Work-Proof**: `<token>` - Required for PUT state requests; this is generated by the `json-work-proof` package.

The JWT must have a scope which agrees with the worksheet URL.

## Endpoints

### GET /api/v1/state/:sha

Retrieves the state for the specified location.

**Headers:**
- `Authorization`: Bearer <JWT>
- `Accept`: application/json
- `Worksheet`: a URI for the educational content

**Response:** JSON object representing the current page state for the user `sub` in the JWT.

**Example:**
```http
GET /api/v1/state/f0e6a6a97042a4f1f1c87f5f7d44315b2d852c2df5c7991cc66241bf7072d1c4
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Accept: application/json
Worksheet: http://example.com
```

### PUT /api/v1/state/:sha

Updates the state for the specified location.

**Headers:**
- `Authorization`: Bearer <JWT>
- `Accept`: application/json
- `Content-Type`: application/json
- `Worksheet`: a URI for the educational content
- `JSON-Work-Proof`: generated by the `json-work-proof` package

**Request Body:** A JSON object representing the state.

**Response:** empty.

**Example:**
```http
PUT /api/v1/state/f0e6a6a97042a4f1f1c87f5f7d44315b2d852c2df5c7991cc66241bf7072d1c4
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Accept: application/json
Content-Type: application/json
Worksheet: http://example.com
JSON-Work-Proof: eyJheyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG...

{
  "state": {
    "key": "value"
  }
}
```

### GET /api/v1/progress/:sha

Retrieves the progress for the specified location.

**Headers:**
- `Authorization`: Bearer <JWT>
- `Accept`: application/json
- `Worksheet`: a URI for the educational content

**Response:** a JSON object with a numeric `progress` property.

**Example:**
```http
GET /api/v1/progress/f0e6a6a97042a4f1f1c87f5f7d44315b2d852c2df5c7991cc66241bf7072d1c4
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Accept: application/json
Worksheet: http://example.com
```

**Example Response:** `{"progress": 1.0}`.

### PUT /api/v1/progress/:sha
Updates the progress for the specified location.

**Headers:**
- `Authorization`: Bearer <JWT>
- `Accept`: application/json
- `Content-Type`: application/json
- `Worksheet`: a URI for the educational content

**Request Body:** a JSON object with a numeric `progress` property.

**Response:**
- **200 OK**
- **Error Responses:**
  - **4xx**: Client errors, e.g., invalid input or unauthorized access.
  - **5xx**: Server errors.

**Example:**
```http
PUT /api/v1/progress/f0e6a6a97042a4f1f1c87f5f7d44315b2d852c2df5c7991cc66241bf7072d1c4
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Accept: application/json
Content-Type: application/json
Worksheet: http://example.com

{
  "progress": 0.75
}
```

